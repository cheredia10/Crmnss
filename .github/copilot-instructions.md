## Objetivo rápido

Este archivo da a los agentes instrucciones prácticas para ser productivos de inmediato en este repositorio (CRM HAMAR — Vite + React + Supabase Functions). Incluye los puntos de entrada, convenciones del proyecto, flujos de integración y riesgos/advertencias.

## Comandos de desarrollo

- Instalar dependencias: `npm i`
- Desarrollo (frontend): `npm run dev` — arranca Vite en el puerto 3000 (ver `vite.config.ts`).
- Build producción: `npm run build` (salida: `build/`).

Nota: las funciones de backend están en `src/supabase/functions/server` y están implementadas para ejecutarse como Supabase Edge Functions / Deno. Para probar/desplegarlas localmente usa la CLI de Supabase (por ejemplo `supabase functions serve` / `supabase start`) o despliega a tu proyecto Supabase.

## Arquitectura (big picture)

- Frontend: React + Vite. Punto de entrada `src/main.tsx` → `src/App.tsx`.
- Componentes UI: `src/components/*`. Primitivas compartidas en `src/components/ui/*`.
- Servicios cliente: llamadas REST hacia funciones supabase encapsuladas en `src/utils/api.ts`.
- Autenticación: `src/services/authService.ts` utiliza `@supabase/supabase-js` (cliente) para iniciar sesión y gestionar sesión/estado.
- Backend (funciones): `src/supabase/functions/server/*` implementa un servidor Hono que expone rutas REST (prefijo `/make-server-d03ded2a/*`) y usa una tabla KV `kv_store_d03ded2a` en Supabase para persistencia.

Por qué: las funciones actúan como un backend ligero (click-to-call, gestión de documentos, registro de clientes/llamadas/tareas) y ofrecen fallback/mocks para CloudTalk cuando la API key no existe o falla.

## Endpoints clave y contrato

- Base (cliente): `https://${projectId}.supabase.co/functions/v1/make-server-d03ded2a` (ver `src/utils/api.ts`).
- Rutas implementadas (ejemplos):
  - `/clientes`, `/clientes/:id`
  - `/llamadas`, `/llamadas/cliente/:clienteId`
  - `/documentos`, `/documentos/upload`, `/documentos/:id/download`
  - `/tareas`, `/stats`
  - `/cloudtalk/*` (integra CloudTalk; la función activa un modo demo si falla la API key)
  - `/signup` (crea usuario vía service role)

Observación: los clientes HTTP en `src/utils/api.ts` envían `Authorization: Bearer <publicAnonKey>` para acceder a las funciones. El servidor, para operaciones administrativas (storage, creación de usuarios), usa variables de entorno: `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY` y `CLOUDTALK_API_KEY` en el entorno Deno/Supabase.

## Convenciones y patrones del proyecto

- Tipado TSX en UI y servicios; muchas funciones y modelos están tipados en `src/utils/api.ts`.
- Navegación interna: `App.tsx` gestiona una string `currentView` y pasa props a vistas (p. ej. `ClientesView`, `LlamadasView`). Evitar introducir routing complejo sin adaptar `App.tsx`.
- Autenticación: el flujo principal confía en `authService.getSession()` y `onAuthStateChange()` para mantener al usuario; no reemplazar sin propagar cambios.
- Archivos autogenerados: `src/utils/supabase/info.tsx` y `src/supabase/functions/server/kv_store.tsx` incluyen encabezados "AUTOGENERATED" — no modificarlos manualmente.
- Assets Figma: `vite.config.ts` contiene alias `figma:asset/<hash>.png` → `src/assets/...`; mantener esos alias si manipulas imágenes que vienen del diseño.

## Integraciones externas y secretos

- Supabase projectId y publicAnonKey están presentes en `src/utils/supabase/info.tsx` (autogenerado). publicAnonKey es usado en el cliente y en las llamadas a las funciones.
- Variables sensibles que el servidor espera en tiempo de ejecución (no deben estar en repo):
  - `SUPABASE_SERVICE_ROLE_KEY` (server-side)
  - `SUPABASE_URL` (server-side)
  - `CLOUDTALK_API_KEY` (para integración CloudTalk)

Advertencia: no mover claves service-role al cliente. Si necesitas cambiar `info.tsx`, documenta la regeneración y evita comprometer keys privadas.

## Errores comunes y comportamientos especiales

- CloudTalk: si la API responde 401, el servidor activa `DEMO_MODE` y usa `CloudTalkMockService`. Evitar tests que dependan de datos reales de CloudTalk sin configurar `CLOUDTALK_API_KEY`.
- Documentos: la subida usa Supabase Storage (bucket `make-d03ded2a-documentos`) y genera URLs firmadas; el código del servidor crea el bucket al iniciarse.
- Autenticación/Signup: `POST /signup` usa la key de servicio para crear usuarios y marca `email_confirm: true` (no hay envío de emails configurado).

## Qué buscar al hacer cambios

- Si cambias un endpoint en `src/supabase/functions/server/index.tsx`, actualiza `src/utils/api.ts` (URL o shape) y revisa los callers en `src/components/*`.
- No rompas la convención de `currentView` en `App.tsx` si sólo necesitas añadir nuevas pantallas: añade casos en `renderView()` y botones en `Sidebar`.
- Si introduces nuevos assets desde Figma, añade alias en `vite.config.ts` o ponlos en `src/assets` y referencia mediante import.

## Preguntas para iterar

- ¿Quieres que incluya instrucciones para ejecutar las funciones Supabase localmente (ej. comandos `supabase` / Deno) en este documento?
- ¿Debo añadir ejemplos concretos de edición de endpoints y pruebas end-to-end locales?

Si falta información o quieres que incluya ejemplos concretos (patches mínimos, reglas de estilo o tests), dime qué priorizar y lo añado.
